// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace FlamingSoftHR.Client.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.AspNetCore.Components.WebAssembly.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using FlamingSoftHR.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using FlamingSoftHR.Client.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using FlamingSoftHR.Client.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using FlamingSoftHR.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using MudBlazor;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/_Imports.razor"
using System.Security.Claims;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/timemanagement/{id}")]
    public partial class TimeManagementPage : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 187 "/Users/cnuila/Proyectos/CodingChallengeFlamingSoft1/FlamingSoftHR/Client/Pages/TimeManagementPage.razor"
       
    [Parameter]
    public string Id { get; set; }

    [Inject]
    public IDialogService DialogService { get; set; }

    [Inject]
    public ILoggedTimeService LoggedTimeService { get; set; }

    [Inject]
    public IEmployeeService EmployeeService { get; set; }

    [Inject]
    ISnackbar Snackbar { get; set; }

    private MudTable<LoggedTime> mudTable { get; set; }

    private DateRange dateRange { get; set; }
    private bool loadingTabla = true;
    private bool loadingEmployeeData = true;

    private string[] regularTime = new string[2];
    private string[] vacationTime = new string[2];
    private string[] sickTime = new string[2];

    private Employee employee = new Employee();

    protected async override Task OnInitializedAsync()
    {
        DateTime date = DateTime.Today;
        dateRange = new DateRange(new DateTime(date.Year, date.Month, 1), date);

        //convert dates to string
        string startDate;
        string endDate;

        if (dateRange.Start != null)
        {
            startDate = ((DateTime)dateRange.Start).ToString("yyyy-MM-dd");
        }
        else
        {
            startDate = (new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1)).ToString("yyyy-MM-dd");
        }

        if (dateRange.End != null)
        {
            endDate = ((DateTime)dateRange.End).ToString("yyyy-MM-dd");
        }
        else
        {
            endDate = DateTime.Today.ToString("yyyy-MM-dd");
        }

        //convert decimals to hours and minutes
        TotalHours totalHours = await LoggedTimeService.GetHours(int.Parse(Id), startDate, endDate);

        regularTime = decimalToHours(totalHours.RegularHours);
        vacationTime = decimalToHours(totalHours.VacationHours);
        sickTime = decimalToHours(totalHours.SickHours);

        employee = await EmployeeService.GetEmployee(int.Parse(Id));
        loadingEmployeeData = false;
    }

    // skip = current page times the size of it in order to get how many of them we want to skip
    // once skip and take are assigned, it queries with the data provided
    private async Task<TableData<LoggedTime>> ServerPaging(TableState tableState)
    {
        int skip = tableState.Page * tableState.PageSize;
        int take = tableState.PageSize;

        //convert dates to string
        string startDate;
        string endDate;

        if (dateRange.Start != null)
        {
            startDate = ((DateTime)dateRange.Start).ToString("yyyy-MM-dd");
        }
        else
        {
            startDate = (new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1)).ToString("yyyy-MM-dd");
        }

        if (dateRange.End != null)
        {
            endDate = ((DateTime)dateRange.End).ToString("yyyy-MM-dd");
        }
        else
        {
            endDate = DateTime.Today.ToString("yyyy-MM-dd");
        }


        LoggedTimeDataResult result = await LoggedTimeService.GetLoggedTimesByEmployee(int.Parse(Id), startDate, endDate, skip, take);
        loadingTabla = false;

        int totalItems = result.Count;

        return new TableData<LoggedTime>() { TotalItems = totalItems, Items = result.LoggedTimes.ToList() };
    }


    // converts a decimal number to hours and return a string[] with the values hours and minutes
    private string[] decimalToHours(decimal hoursDate)
    {
        int hours = (int)hoursDate;

        decimal decimalMinutes = hoursDate - hours;

        int minutes = Convert.ToInt32((double)decimalMinutes * 60.00);

        string[] timeArray = new string[2];
        timeArray[0] = hours.ToString();
        timeArray[1] = minutes.ToString();

        return timeArray;
    }

    protected async void AddLoggedTime()
    {
        var parameters = new DialogParameters();
        parameters.Add("LoggedTime", new LoggedTime() { DateLogged  = DateTime.Today });

        var dialog = DialogService.Show<AddUpdateTimeManagement>("Add Logged Time", parameters);

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            LoggedTime loggedTimeToAdd = (LoggedTime)result.Data;
            loggedTimeToAdd.EmployeeId = int.Parse(Id);

            LoggedTime response = await LoggedTimeService.AddLoggedTime(loggedTimeToAdd);

            if (response != null)
            {
                await mudTable.ReloadServerData();
                Snackbar.Add($"Logged Time Created Successfully", Severity.Success);
            }
        }
    }

    protected async void UpdateLoggedTime(int id)
    {
        LoggedTime loggedTimeToUpdate = await LoggedTimeService.GetLoggedTime(id);

        var parameters = new DialogParameters();
        parameters.Add("LoggedTime", loggedTimeToUpdate);

        var dialog = DialogService.Show<AddUpdateTimeManagement>("Update Logged Time", parameters);

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            LoggedTime response = await LoggedTimeService.UpdateLoggedTime((LoggedTime)result.Data);

            if (response != null)
            {
                await mudTable.ReloadServerData();
                Snackbar.Add($"Logged Time Updated Successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"An error has ocurred", Severity.Error);
            }
        }

    }

    protected async void DeleteLoggedTime(int id)
    {
        await LoggedTimeService.DeleteLoggedTime(id);
        await mudTable.ReloadServerData();
        Snackbar.Add($"Logged Time Deleted Successfully", Severity.Success);
    }

#line default
#line hidden
#nullable disable
    }
}
#pragma warning restore 1591
